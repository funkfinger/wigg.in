I"≤<p>This <strong>MOSTLY</strong> is working, so, here‚Äôs what I found when trying to connect to Facebook with OAuth. It needs some <strong>serious refactoring</strong> because a lot of this was done in an ‚Äúinvestigative‚Äù trial and error way. It also looks like Facebook have improved their <a href="http://developers.facebook.com/docs/api">docs on this</a> since I was first looking at them‚Ä¶</p>

<p>First, you need to initiate a connection:</p>

<pre lang="ruby">
    get '/:blog_name/facebook/oauth/create' do
      redirect "https://graph.facebook.com/oauth/authorize?client_id=##FACEBOOK API KEY##&amp;redirect_uri=##CALLBACK URL##&amp;scope=publish_stream,user_status,user_photos,user_about_me"
    end
</pre>

<p>where <code>##FACEBOOK API KEY##</code> = your applications API key (mine is a 32 digit hex value) and <code>##CALLBACK URL##</code> = the URL that will be processing the next step. Also, the scope value let‚Äôs you get more access to the user‚Äôs account. Check their <a href="http://developers.facebook.com/docs/authentication/permissions">extended permissions</a> doc for more info.</p>

<p>Next, you need to process what comes back from Facebook. I am stashing what comes back in the DB (the <code> FacebookOauthToken</code> model). Also using the <code>Mechanize</code> gem which is pretty silly. Some of the code below is specific to my app, so ignore those bits‚Ä¶</p>

<pre lang="ruby">
    get '/:blog_name/facebook/oauth/callback' do
      if !params['code'].blank?
url="https://graph.facebook.com/oauth/access_token"
client_id="client_id=##CLIENT ID##"
client_secret="client_secret=## CLIENT SECRET ##"
code="code=#{URI.escape(params['code'])}"
redirect_uri="redirect_uri=http://example.org/#{@blog.url_name}/facebook/oauth/callback"
      
url="#{url}?#{client_id}&amp;#{client_secret}&amp;#{code}&amp;#{redirect_uri}"
begin
  res=open(url)
rescue
  flash[:error]="There was a problem connecting to Facebook"
  redirect "/#{@blog.url_name}/"
end
read=res.read
access_token=CGI.parse(read)['access_token']
if !access_token.blank?
  @blog.facebook_oauth_token = FacebookOauthToken.new(:access_token=&gt;access_token,:blog_name=&gt;params[:blog_name])
  if @blog.save
    begin
      a=Mechanize.new
      res=a.get("https://graph.facebook.com/me/?access_token=#{access_token}")
      @blog.facebook_oauth_token.facebook_id=JSON(res.body)['id']
      @blog.save!
    rescue
      flash[:error]="There was a problem getting information from Facebook"
      redirect "/#{@blog.url_name}/"
    end
    flash[:notice]="Facebook connection created!"
    redirect "/#{@blog.url_name}/"
  else
    flash[:error]="There was a problem saving Facebook connection"
    redirect "/#{@blog.url_name}/"
  end
else
  flash[:error]="There was a problem making Facebook connection"
  redirect "/#{@blog.url_name}/"
end
      else
flash[:error]="There was a problem connecting to Facebook"
redirect "/#{@blog.url_name}/"
      end
    end

</pre>

<p>Where <code>##CLIENT ID##</code> = your <strong>Application ID</strong> (mine is a 12 digit numeric value) and <code>## CLIENT SECRET ##</code> = your <strong>Application Secret</strong> (mine is a 32 digit hex value).</p>

<p>Once you have an <code>access_token</code> you should be able to make calls to URLs like this: <code>
"https://graph.facebook.com/me/?access_token=#{access_token}"</code>. The <code>/me</code> path is the connected user‚Äôs data and I‚Äôm grabbing their Facebook ID from the returned JSON for use elsewhere.</p>
:ET